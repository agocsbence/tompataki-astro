---
import loadIcon from '../assets/load.gif';
import searchIcon from '../assets/search.svg';
import logoBlack from '../assets/logo-black.png';
import { Image } from "astro:assets";
---

<!-- <div class="preloader-wrapper">
  <div class="preloader">
    <img src={loadIcon.src} alt="loading...">
  </div>
</div> -->

<section id="header">
  <div id="headline">
    <a href="/">
      <Image src={logoBlack.src} alt="Tom Pataki logo" width="192" height="18" sizes="(max-width: 250px) 180px, 192px" loading="lazy" />
    </a>
    <span>EN | HU</span>
  </div>

  <div id="navbar">
    <div id="navbar-wrapper">
      <div class="menu-main-menu-container">
        <ul id="menu-main-menu" class="menu">
          <li id="menu-item-265" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-265"><a href="/feature-films">Feature films / Series</a></li>
          <li id="menu-item-64" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-64"><a href="/commercials">Commercials</a></li>
          <li id="menu-item-63" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-63"><a href="/special-projects">Special projects</a></li>
          <li id="menu-item-62" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-62"><a href="/showreel">Showreel</a></li>
          <li id="menu-item-61" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-61"><a href="/about">About</a></li>
          <li id="menu-item-60" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-60"><a href="/contact">Contact</a></li>
        </ul>
      </div>

      <a href="/search"><img src={searchIcon.src} alt="Search" id="searchButton" width="16" height="16"></a>
    </div>
  </div>
</section>

<!-- desktopon marad (mobilon CSS-sel elrejtjük) -->
<div id="search-overlay">
  <div id="search-overlay-wrapper">
    <span id="searchClose">X</span>
    <form role="search" method="get" id="searchform" action="/search">
      <div>
        <label for="q">Search anything and hit enter</label>
        <input type="text" value="" name="q" id="q" placeholder="Search" />
        <input type="submit" id="searchsubmit" value="Search" class="button" />
      </div>
    </form>
  </div>
</div>

<!-- MOBIL HEADER: nincs duplikált <ul>, csak egy üres konténer, amit JS feltölt -->
<section id="mobile-header">
  <div id="logo">
    <a href="/">
      <Image src={logoBlack.src} alt="Tom Pataki logo" width="192" height="18" sizes="(max-width: 250px) 180px, 192px" loading="lazy" />
    </a>
  </div>

  <div id="menu">
    <button
      type="button"
      id="mobileMenuButton"
      class="mobile-menu-btn"
      aria-label="Open menu"
      aria-controls="mobile-navbar"
      aria-expanded="false"
    >
      &#9776;
    </button>
  </div>

  <!-- EZ a lenyíló rész: ide klónozzuk a desktop menüt -->
  <div id="mobile-navbar" class="mobile-nav" aria-hidden="true">
    <div class="menu-main-menu-container" id="mobile-menu-container"></div>
  </div>
</section>

<script is:inline>
  const isMobile = () => window.matchMedia("(max-width: 991px)").matches;

  window.addEventListener("DOMContentLoaded", () => {
    const mobileBtn = document.getElementById("mobileMenuButton");
    const mobileNav = document.getElementById("mobile-navbar");
    const mobileContainer = document.getElementById("mobile-menu-container");
    const desktopMenu = document.getElementById("menu-main-menu");

    if (!mobileBtn || !mobileNav || !mobileContainer || !desktopMenu) return;

    function ensureMobileMenuBuilt() {
        if (mobileContainer.dataset.built === "true") return;

        const clone = desktopMenu.cloneNode(true);

        // Ne legyen duplikált ID a DOM-ban
        clone.removeAttribute("id");
        clone.querySelectorAll("[id]").forEach((el) => el.removeAttribute("id"));

        // KRITIKUS: szedd le a desktop/WP classokat, amik mobilon elrejthetik
        clone.className = "mobile-menu-list";

        // Biztos, ami biztos: list-style reset
        clone.setAttribute("role", "list");

        mobileContainer.appendChild(clone);
        mobileContainer.dataset.built = "true";
    }

    function setOpen(open) {
      mobileNav.classList.toggle("is-open", open);
      mobileBtn.setAttribute("aria-expanded", open ? "true" : "false");
      mobileNav.setAttribute("aria-hidden", open ? "false" : "true");
    }

    mobileBtn.addEventListener("click", () => {
      if (!isMobile()) return;
      ensureMobileMenuBuilt();
      setOpen(!mobileNav.classList.contains("is-open"));
    });

    mobileNav.addEventListener("click", (e) => {
      const a = e.target.closest("a");
      if (a) setOpen(false);
    });

    window.addEventListener("resize", () => {
      if (!isMobile()) setOpen(false);
    });
  });
</script>

<style>
  /* desktop search overlay kezelése (a meglévő logikád) */
  #search-overlay { display: none; }
  #search-overlay.is-open { display: block; }

  /* =========================
     MOBIL FIXEK CSAK MOBILON
     Desktop CSS-t nem bántjuk
     ========================= */
  @media screen and (max-width: 991px) {
    /* mobilon nincs search ikon és overlay */
    #searchButton { display: none !important; }
    #search-overlay { display: none !important; }

    /* mobil header layout: logo bal, hamburger jobb */
    #mobile-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 3rem;
      line-height: 3rem;
      padding: 0 1rem;
    }
    #mobile-header {
        position: relative;
        z-index: 1500;
    }

    /* logo ne torzuljon */
    #mobile-header #logo img {
      height: 2rem;
      width: auto;
      max-width: 100%;
      object-fit: contain;
      display: block;
    }

    .mobile-menu-btn {
      appearance: none;
      border: 0;
      background: transparent;
      cursor: pointer;
      font-size: 20px;
      line-height: 1;
      padding: 10px;
      border-radius: 10px;
    }
    .mobile-menu-btn:hover {
      background: rgba(0,0,0,0.05);
    }

    /* lenyíló nav: alapból rejtve */
    #mobile-navbar {
        display: none;
        position: fixed;
        left: 0;
        right: 0;
        top: 3rem;           /* header magasság */
        background: #fff;
        border-top: 1px solid rgba(0,0,0,0.08);
        padding: 0.5rem 1rem 0.75rem;
        z-index: 1600;
    }
    #mobile-navbar.is-open { display: block; }

    /* a klónozott lista legyen egymás alatt */
    #mobile-navbar .mobile-menu-list {
      margin: 0;
      padding: 0.25rem 0 0;
      list-style: none;
      display: grid;
      gap: 6px;
    }

    #mobile-navbar .mobile-menu-list li {
      margin: 0;
      padding: 0;
      list-style: none;
    }

    #mobile-navbar .mobile-menu-list a {
      display: block;
      padding: 10px 12px;
      border-radius: 12px;
    }

    #mobile-navbar .mobile-menu-list a:hover {
      background: rgba(0,0,0,0.05);
    }
    @media screen and (max-width: 991px) {
        /* A konténer ne örököljön semmi "levágós" szabályt */
        #mobile-menu-container {
            display: block !important;
            height: auto !important;
            max-height: none !important;
            overflow: visible !important;
        }

        /* A klónozott lista: fixen látszódjon */
        #mobile-navbar .mobile-menu-list {
            display: grid !important;
            grid-auto-flow: row;
            gap: 6px;

            margin: 0 !important;
            padding: 0.25rem 0 0 !important;

            height: auto !important;
            max-height: none !important;
            overflow: visible !important;

            list-style: none !important;
        }

        #mobile-navbar .mobile-menu-list > li {
            display: block !important;
            height: auto !important;
        }

        #mobile-navbar .mobile-menu-list a {
            display: block !important;
            padding: 10px 12px;
            border-radius: 12px;
        }
    }
  }
  @media screen and (max-width: 991px) {
    #mobile-navbar.is-open {
        height: auto !important;
        max-height: calc(100dvh - 3rem) !important;
        overflow: auto !important;
    }
  }
</style>