---
interface Props {
  /** Vimeo link: https://vimeo.com/ID vagy https://player.vimeo.com/video/ID */
  url: string;
  /** opcionális: ha a wrappernek kell class */
  class?: string;
  /** opcionális: aria label */
  ariaLabel?: string;
}
const { url, class: className = "", ariaLabel = "Play video" } = Astro.props;
---

<button
  type="button"
  class={`vimeo-lightbox-trigger ${className}`}
  data-vimeo-url={url}
  aria-label={ariaLabel}
>
  <slot />
</button>

<style is:global>
  .vimeo-lightbox-trigger {
    all: unset;
    cursor: pointer;
    display: contents; /* a belső markup maradjon a layoutban */
  }

  .vimeo-lightbox-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.86);
    z-index: 9999;
    display: grid;
    place-items: center;
    padding: 16px;
  }

  .vimeo-lightbox-modal {
    width: min(100%, 980px);
    aspect-ratio: 16 / 9;
    background: #000;
    position: relative;
    border-radius: 12px;
    overflow: hidden;
  }

  .vimeo-lightbox-close {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 40px;
    height: 40px;
    border-radius: 999px;
    background: transparent;
    color: #fff;
    display: grid;
    place-items: center;
    font-size: 22px;
    border: 0;
    cursor: pointer;
    z-index: 2;
  }

  .vimeo-lightbox-iframe {
    width: 100%;
    height: 100%;
    border: 0;
  }
</style>

<script is:inline>
  if (!window.__vimeoLightboxInit) {
    window.__vimeoLightboxInit = true;

    function toPlayerUrl(raw) {
      try {
        const u = new URL(raw);
        if (u.hostname.includes("player.vimeo.com")) return raw;

        // vimeo.com/12345678 -> 12345678
        const parts = u.pathname.split("/").filter(Boolean);
        const id = parts[0];
        if (!id) return raw;

        const p = new URL(`https://player.vimeo.com/video/${id}`);
        p.searchParams.set("autoplay", "1");
        p.searchParams.set("title", "0");
        p.searchParams.set("byline", "0");
        p.searchParams.set("portrait", "0");
        return p.toString();
      } catch {
        return raw;
      }
    }

    function close() {
      const overlay = document.querySelector(".vimeo-lightbox-overlay");
      if (overlay) overlay.remove();
      document.documentElement.style.overflow = "";
    }

    function open(rawUrl) {
      const url = toPlayerUrl(rawUrl);

      close();
      document.documentElement.style.overflow = "hidden";

      const overlay = document.createElement("div");
      overlay.className = "vimeo-lightbox-overlay";
      overlay.addEventListener("click", (e) => {
        if (e.target === overlay) close();
      });

      const modal = document.createElement("div");
      modal.className = "vimeo-lightbox-modal";

      const closeBtn = document.createElement("button");
      closeBtn.className = "vimeo-lightbox-close";
      closeBtn.type = "button";
      closeBtn.textContent = "×";
      closeBtn.addEventListener("click", close);

      const iframe = document.createElement("iframe");
      iframe.className = "vimeo-lightbox-iframe";
      iframe.src = url;
      iframe.allow = "autoplay; fullscreen; picture-in-picture";
      iframe.allowFullscreen = true;

      modal.appendChild(closeBtn);
      modal.appendChild(iframe);
      overlay.appendChild(modal);
      document.body.appendChild(overlay);

      closeBtn.focus();
    }

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") close();
    });

    document.addEventListener("click", (e) => {
      const btn = e.target.closest?.(".vimeo-lightbox-trigger");
      if (!btn) return;
      const url = btn.getAttribute("data-vimeo-url");
      if (!url) return;
      e.preventDefault();
      open(url);
    });
  }
</script>
