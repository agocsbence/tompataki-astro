---
import Layout from '../layouts/Layout.astro';
import IndexSliderMobile from '../components/IndexSliderMobile.astro';
import IndexSlider from '../components/IndexSlider.astro';
import IndexReels from '../components/IndexReels.astro';
import TermsConditions from '../components/TermsConditions.astro';
let slides = await fetch('https://cms.tompataki.com/wp-json/wp/v2/index_slider?_embed&acf_format=standard').then((r) => r.json());
let reels = await fetch('https://cms.tompataki.com/wp-json/wp/v2/reel?_embed&acf_format=standard').then((r) => r.json());
let posts = await fetch('https://cms.tompataki.com/wp-json/wp/v2/posts?_embed&acf_format=standard').then((r) => r.json());
---

<Layout bodyClass="home" description="Newest projects, reels, and related news about me">
	<div id="mobile-index-slider" class="mobile-only">
        <h2>Newest projects</h2>
        <div id="mobile-index-slider-container">
            <div class="swiper-wrapper">
				{
					slides.map((slide, i) => 
						<IndexSliderMobile
                            priority={i === 0}
							title={slide.title.rendered}
							image={slide.acf.mobile_slider_image}
							director={slide.acf.director}
							videoLogo={slide.acf.video_logo}
							vimeoUrl={slide.acf.vimeo_url} />
					)
				}             
            </div>

            <!-- <div class="swiper-button-prev swiper-button-white"><span>Prev</span></div> -->
            <div class="swiper-button-next swiper-button-white"><span>Next</span></div>
        </div>
    </div>

    <section id="index-slider" class="desktop-only">
        <h2>Newest projects</h2>
        <div id="index-slider-container">
            <div class="swiper-wrapper">
				{
					slides.map((slide) => 
						<IndexSlider 
							id={slide.id}
							title={slide.title.rendered}
							shortVimeoId={slide.acf.short_vimeo_id}
							director={slide.acf.director}
							videoLogo={slide.acf.video_logo}
							vimeoUrl={slide.acf.vimeo_url}
                            muxId={slide.acf.mux_id} />
					)
				} 
            </div>

            <div class="swiper-pagination swiper-pagination-white"></div>

            <div class="swiper-button-prev swiper-button-white"></div>
            <div class="swiper-button-next swiper-button-white"></div>
        </div>
    </section>
    <section id="reel" class="desktop-only">
        <h1>- Reel -</h1>
        <div class="grid-gap">
            {
				reels.map((reel) => 
					<IndexReels 
						id={reel.id}
						image={reel._embedded['wp:featuredmedia'][0].source_url}
						director={reel.acf.directed_by}
						videoUrl={reel.acf.vimeo_url}
						title={reel.title.rendered}
						subtitle={reel.acf.sub_title} />
				)
			}
        </div>
    </section>
    <section id="news" class="desktop-only">
        <h1>
            Related
        </h1>
        <div id="news-list">
            <div class="swiper-wrapper">
                {
                    posts.map((post) => 

                        <div class="swiper-slide">
                            <div class="news-list-item">
                                <div class="image" style={`background-image: url(${post._embedded['wp:featuredmedia'][0].source_url});`}></div>
                                <div class="text">
                                    <div class="news-category">
                                        <span>{post.acf.category}</span>
                                    </div>
                                    <h2><a href={post.acf.website_link} target="blank">{post.title.rendered}</a></h2>
                                    <div set:html={post.excerpt.rendered}></div>
                                    <div class="news-meta">
                                        <div class="span-50 left">
                                            <span><a href={post.acf.website_link} target="blank">CHECK IT OUT</a></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )
                }
            </div>
            <div class="swiper-button-prev prevB swiper-button-white"></div>
            <div class="swiper-button-next nextB swiper-button-white"></div>

        </div>
    </section>
    <TermsConditions />
</Layout>

<script>
    import Swiper from 'swiper';
    import { Navigation, Pagination, Autoplay } from 'swiper/modules';
    import 'swiper/css';
    import 'swiper/css/navigation';
    import 'swiper/css/pagination';
    import 'swiper/css/autoplay';

    document.addEventListener( 'DOMContentLoaded', function() {

        if( /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
            const hero_mobile_swiper = new Swiper("#mobile-index-slider-container", {
                modules: [Navigation, Pagination, Autoplay],
                loop: true,
                speed: 800,
                navigation: {
                    nextEl: '.swiper-button-next',
                    prevEl: '.swiper-button-prev',
                },
                autoplay: {
                    delay: 4000,
                    disableOnInteraction: false,
                },
                pagination: {
                    el: '.swiper-pagination',
                    // dynamicBullets: true,
                    clickable: true,
                }
            });
        } else {
            const hero_swiper = new Swiper("#index-slider-container", {
                modules: [Navigation, Pagination, Autoplay],
                speed: 800,
                preventClicks: false,
                preventClicksPropagation: false,
                slideActiveClass: 'slider-video-active',
                loop: true,
                watchSlidesProgress: false,
                autoplay: {
                    delay: 4000,
                    disableOnInteraction: false,
                },
                on: {
                    slideChange: function() {
                        const videos = document.querySelectorAll(".swiper-slide iframe");
                        videos.forEach(v => {
                            if (v.pause) v.pause();
                        });

                        const activeSlide = document.getElementsByClassName("slider-video-active")[0];
                        if (activeSlide) {
                            const iframe = activeSlide.querySelector("iframe");
                            if (iframe && iframe.play) iframe.play();
                        }
                    }
                },                
                navigation: {
                    nextEl: '.swiper-button-next',
                    prevEl: '.swiper-button-prev',
                },
                pagination: {
                    el: '.swiper-pagination',
                    // dynamicBullets: true,
                    clickable: true,
                }
            });
        }
    });

    const newsSwiper = new Swiper('#news-list', {
        modules: [Navigation],
        loop: false,
        slidesPerView: 3,
        spaceBetween: 32,
        navigation: {
            nextEl: '.nextB',
            prevEl: '.prevB',
        }
    });
</script>