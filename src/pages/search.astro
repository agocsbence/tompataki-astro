---
import Layout from '../layouts/Layout.astro';
export const prerender = false;

const q = new URL(Astro.request.url).searchParams.get("q")?.trim() ?? "";
let results = [];

const base = "https://cms.tompataki.com/wp-json/wp/v2";

const types = ["post", "page", "commercials", "special_projects", "featured_films"];

const typeLabel = {
  post: "Post",
  page: "Page",
  commercials: "Commercial",
  special_projects: "Special Project",
  featured_films: "Feature film / Series",
};

function pickFeaturedImage(post) {
  const fm = post?._embedded?.["wp:featuredmedia"]?.[0];
  if (!fm) return "";
  const sizes = fm.media_details?.sizes;
  return (
    sizes?.medium_large?.source_url ||
    sizes?.large?.source_url ||
    sizes?.medium?.source_url ||
    fm.source_url ||
    ""
  );
}

function normalize(post, type) {
  const title = typeof post.title === "object"
    ? post.title.rendered
    : (post.title ?? "");

  const acf = post.acf ?? {};
  const hasVimeo = !!acf.vimeo_url;

  return {
    id: `${type}:${post.id}`,
    path: `/${type}/${post.slug}`,
    type,
    typeLabel: typeLabel[type] ?? type,
    title,
    href: acf.vimeo_url ?? post.link ?? "#",
    hasVimeo,
    subtitle: acf.sub_title ?? "",
    directedBy: acf.directed_by ?? "",
    image: pickFeaturedImage(post),
    raw: post,
  };
}

async function fetchType(type) {
  const url = new URL(`${base}/${type}`);
  url.searchParams.set("_embed", "1");
  url.searchParams.set("search", q);
  url.searchParams.set("per_page", "20");
  url.searchParams.set("status", "publish");

  const res = await fetch(url.toString(), {
    headers: { "Accept": "application/json" },
  });

  if (!res.ok) {
    const txt = await res.text();
    console.log(`WP ${type} search error:`, res.status, txt);
    return [];
  }

  const data = await res.json();
  if (!Array.isArray(data)) return [];

  return data.map((p) => normalize(p, type));
}

if (q.length >= 2) {
  const settled = await Promise.allSettled(types.map(fetchType));
  results = settled
    .flatMap((r) => (r.status === "fulfilled" ? r.value : []))
    // dedupe (néha átfedhet)
    .reduce((acc, item) => {
      if (!acc.seen.has(item.id)) {
        acc.seen.add(item.id);
        acc.items.push(item);
      }
      return acc;
    }, { seen: new Set(), items: [] }).items
    .slice(0, 40);
}
---

<Layout bodyClass="search search-results" description="Search page">

  <section id="search-results">
    <div id="search-input-wrapper">
      <form role="search" method="get" id="searchform" action="/search">
        <div>
          <label for="q">Search anything and hit enter</label>
          <input type="text" value={q} name="q" id="q" placeholder="Search" />
          <input type="submit" id="searchsubmit" value="Search" class="button" />
        </div>
      </form>
    </div>

    {q.length < 2 ? (
      <p>Type at least 2 characters.</p>
    ) : results.length === 0 ? (
      <p>No results.</p>
    ) : (
      <div id="search-results-wrapper" class="grid-gap">
        {results.map((r) => (
          <div class={`search-result grid-item ${r.hasVimeo ? "play" : ""}`}>
            <a href={`${r.hasVimeo ? r.href : r.path}`}>
              <div
                class="thumbnail"
                style={r.image ? `background-image: url(${r.image})` : ""}
                aria-label={r.title}
              ></div>

              <div class="details">
                <h2>{r.title}</h2>
                {r.subtitle && <p class="subtitle">{r.subtitle}</p>}
                {r.directedBy && (
                  <p>
                    DIRECTOR <span>{r.directedBy}</span>
                  </p>
                )}
                <div class="type">{r.typeLabel}</div>
              </div>
            </a>
          </div>
        ))}
      </div>
    )}
  </section>

</Layout>

<style>
  .details .type {
    background: #fff;
    color: #000;
    padding: 2px 4px;
    display: inline-block;
    font-size: .5rem;
  }
</style>
